#############################################################################
# Don't touch these...
#############################################################################

this_makefile := ${lastword ${MAKEFILE_LIST}}
SHELL = @bash@ -o pipefail -o errexit -o nounset
.SECONDARY:

#############################################################################
# autoconf / configure things

# autoconf standard things
builddir = @builddir@
srcdir = @srcdir@

SED = @SED@
MKDIR_P = @MKDIR_P@

# local autoconf things

realpath = @realpath@
saxon = @saxon@
schematron_compile = @schematron_compile@
schematron_execute = @schematron_execute@
xs_validate = @xs_validate@

#############################################################################
# local variables

tmp_dir = ${builddir}/tmp
tokens_dir = ${tmp_dir}/tokens

model_xml_files = \
  ${srcdir}/metamodel/metamodel.xml \
  ${srcdir}/examples/claim/claim-extensions-model.xml \

valid_tokens = \
    ${model_xml_files:${srcdir}/%=${tokens_dir}/rules-for-niem-data-sch-valid/%} \
    ${model_xml_files:${srcdir}/%=${tokens_dir}/rules-for-models-sch-valid/%} \
    ${model_xml_files:${srcdir}/%=${tokens_dir}/xsd-for-models-valid/%} \

all_files = \
    ${tokens_dir}/generate-xsd-for-models \
    ${tokens_dir}/generate-xsd-for-claim \

clean_dirs = ${srcdir}/schema-for-models/model


# valid_tokens = ${tokens_dir}/model-rules-sch-valid/metamodel/metamodel.xml

#############################################################################

#HELP:Default goal is "all"
.DEFAULT_GOAL = all

.PHONY: all #   Build everything
all: ${all_files}

.PHONY: valid #   Validate what you can
valid: ${valid_tokens}

.PHONY: clean #   Remove build products
clean:
	${RM} ${valid_tokens}
	${RM} ${all_files}
	${RM} -r ${clean_dirs}

#############################################################################

${tokens_dir}/generate-xsd-for-models: metamodel/metamodel.xml
	${RM} -r ${srcdir}/schema-for-models/model
	${MKDIR_P} ${srcdir}/schema-for-models/model
	${saxon} --in=$< \
	  --xsl=${srcdir}/model-to-xsd/model-to-xsd.xsl \
	  -- target-dir=${shell ${realpath} ${srcdir}/schema-for-models/model}
	${MKDIR_P} ${dir $@} && touch $@

${tokens_dir}/generate-xsd-for-claim: examples/claim/claim-extensions-model.xml
	${RM} -r ${srcdir}/examples/claim/xsd/claim
	${MKDIR_P} ${srcdir}/examples/claim/xsd/claim
	${saxon} --in=$< \
	  --xsl=${srcdir}/model-to-xsd/model-to-xsd.xsl \
	  -- target-dir=${shell ${realpath} ${srcdir}/examples/claim/xsd/claim}
	${MKDIR_P} ${dir $@} && touch $@

.PHONY: xsd #   Build XSDs from the metamodel
update-xsd: ${srcdir}/metamodel-core/metamodel.xml
	${saxon} \
	  -i ${srcdir}/metamodel-core/metamodel.xml \
	  -x ${srcdir}/model-to-xsd/generate-xsd.xsl \
	  -o ${builddir}/model-to-xsd/report/generate-xsd/metamodel-core/metamodel.xml \
	  -- target-dir=${abs_builddir}/xsd
	${RM} -r ${srcdir}/metamodel-core/xsd/metamodel
	${MKDIR_P} ${srcdir}/metamodel-core/xsd/metamodel
	tar -C ${builddir}/xsd -c . | tar -C ${srcdir}/metamodel-core/xsd/metamodel -xv

#############################################################################
# Schematron validation rules


# rules-for-niem-data-sch-valid : validate a model against the Schematron rules for NIEM data
${tokens_dir}/rules-for-niem-data-sch-valid/%: % ${srcdir}/common/rules-for-niem-data.sch.xsl
	${schematron_execute} --xslt-file=${srcdir}/common/rules-for-niem-data.sch.xsl $<
	${MKDIR_P} ${dir $@} && touch $@

# rules-for-models-sch-valid : Validate a model against the Schematron rules for models
${tokens_dir}/rules-for-models-sch-valid/%: % ${srcdir}/schema-for-models/rules-for-models.sch.xsl
	${schematron_execute} --xslt-file=${srcdir}/schema-for-models/rules-for-models.sch.xsl $<
	${MKDIR_P} ${dir $@} && touch $@



%.sch.xsl: %.sch
	${RM} $@
	${schematron_compile} --output-file=$@ $<
	chmod 444 $@


${tokens_dir}/xsd-for-models-valid/%.xml: %.xml ${tokens_dir}/generate-xsd-for-models
	${xs_validate} --catalog=${srcdir}/schema-for-models/xml-catalog.xml $<
	${MKDIR_P} ${dir $@} && touch $@


#############################################################################

.PHONY: update-docs #   Build documentation from the metamodel
update-docs:
	${MAKE} -C docs-src
	${MAKE} -C docs-src uninstall
	${MAKE} -C docs-src install

#############################################################################

.PHONY: help #   Print this help
help:
	@ ${SED} -e '/^\.PHONY:/s/^\.PHONY: *\([^ #]*\) *\#\( *\)\([^ ].*\)/\2\1: \3/p;/^[^#]*#HELP:/s/[^#]*#HELP:\(.*\)/\1/p;d' ${this_makefile}

# don't put anything after this



